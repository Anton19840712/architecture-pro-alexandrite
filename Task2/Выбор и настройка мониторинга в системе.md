# Выбор и настройка мониторинга в системе "Александрит"

---

## 1. Мотивация

### Почему необходим мониторинг

**Текущая ситуация:**
- Компания узнает о проблемах от недовольных клиентов (реактивный подход)
- Невозможно определить причину потери заказов без ручного анализа
- Нет данных о производительности системы
- Яндекс Метрика покрывает только B2C веб-интерфейс, B2B API не мониторится

**Бизнес-проблемы без мониторинга:**
1. Потеря клиентов и контрактов из-за необнаруженных сбоев
2. Длительное время реагирования на инциденты (часы/дни вместо минут)
3. Невозможность планирования масштабирования
4. Репутационные риски

### Что даст внедрение мониторинга

| Выгода | Описание |
|--------|----------|
| **Проактивное обнаружение проблем** | Алерты до того, как клиенты заметят сбой |
| **Сокращение MTTR** | Mean Time To Recovery с часов до минут |
| **Capacity planning** | Данные для планирования масштабирования |
| **SLA compliance** | Возможность гарантировать SLA партнерам |
| **Обоснование инвестиций** | Данные для бизнес-решений о развитии инфраструктуры |

### ROI мониторинга

- **Текущие потери:** несколько крупных контрактов, растущее недовольство клиентов
- **Стоимость внедрения:** инфраструктура + время команды
- **Ожидаемый эффект:** предотвращение потерь, сокращение времени простоя

---

## 2. Выбор подхода к мониторингу

### Используемые методологии

Для разных компонентов системы применяются разные подходы:

| Компонент | Подход | Обоснование |
|-----------|--------|-------------|
| **API-сервисы** (Shop, CRM, MES) | **RED** (Rate, Errors, Duration) | Оптимален для request-driven сервисов, фокус на пользовательском опыте |
| **Базы данных** (PostgreSQL) | **USE** (Utilization, Saturation, Errors) | Подходит для ресурсов с ограничением по capacity |
| **RabbitMQ** | **USE + специфичные** | Очередь - это ресурс; добавляем специфичные метрики очередей |
| **S3 хранилище** | **USE** | Ресурс с ограничением по объему |
| **Инфраструктура** (EC2) | **USE** | Классический подход для железа/виртуалок |

### Почему не только "Четыре золотых сигнала"?

Четыре золотых сигнала (Latency, Traffic, Errors, Saturation) - это упрощенная версия, которая хорошо работает для начального уровня. Мы используем более детальные подходы (RED + USE), которые дают больше контекста для диагностики.

---

## 3. Метрики для отслеживания

### 3.1 RabbitMQ (USE + специфичные)

#### Number of dead-letter-exchange letters in RabbitMQ
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Критически важно! DLQ показывает сообщения, которые не удалось обработать. В контексте "Александрита" - это потенциально потерянные заказы |
| **Ярлыки** | `queue_name` (имя исходной очереди), `reason` (причина попадания в DLQ: rejected, expired, maxlen) |
| **Пороговое значение** | > 0 требует немедленного разбора, > 10 - критический алерт |

#### Number of messages in flight in RabbitMQ
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Показывает saturation очереди. Рост = consumers не успевают обрабатывать, риск потери при переполнении |
| **Ярлыки** | `queue_name`, `vhost` |
| **Пороговое значение** | Зависит от baseline, рост > 200% от нормы - алерт |

### 3.2 Shop API (RED)

#### Number of requests (RPS) for Shop API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Rate - базовая метрика нагрузки. Позволяет видеть паттерны использования, обнаруживать аномалии (DDoS, вирусный трафик) |
| **Ярлыки** | `endpoint` (путь), `method` (GET/POST), `status_code_class` (2xx/4xx/5xx) |

#### Response time (latency) for Shop API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Duration - ключевая метрика пользовательского опыта. Медленный API = потеря клиентов |
| **Ярлыки** | `endpoint`, `method`, `quantile` (p50, p95, p99) |
| **Пороговое значение** | p95 > 500ms - warning, p95 > 2s - critical |

#### Number of HTTP 500 for Shop API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Errors - серверные ошибки означают проблемы в коде или инфраструктуре |
| **Ярлыки** | `endpoint`, `error_type` (если доступно) |
| **Пороговое значение** | Error rate > 1% - warning, > 5% - critical |

#### Number of HTTP 200 for Shop API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Успешные запросы для расчета error rate и понимания нормальной нагрузки |
| **Ярлыки** | `endpoint`, `method` |

#### CPU % for Shop API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Utilization - показывает загрузку сервиса, нужна для capacity planning |
| **Ярлыки** | `instance_id` |
| **Пороговое значение** | > 70% sustained - warning, > 90% - critical |

#### Memory Utilisation for Shop API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Утечки памяти, OOM killer - частые причины сбоев |
| **Ярлыки** | `instance_id` |
| **Пороговое значение** | > 80% - warning, > 95% - critical |

### 3.3 CRM API (RED)

#### Number of requests (RPS) for CRM API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Мониторинг активности продавцов, базовая нагрузка |
| **Ярлыки** | `endpoint`, `method`, `user_role` (seller/admin) |

#### Response time (latency) for CRM API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Производительность для внутренних пользователей влияет на скорость обработки заказов |
| **Ярлыки** | `endpoint`, `method`, `quantile` |

#### Number of HTTP 500 for CRM API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Ошибки CRM = проблемы с подтверждением заказов, блокировка бизнес-процесса |
| **Ярлыки** | `endpoint` |

#### CPU % for CRM API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Capacity planning для CRM сервиса |
| **Ярлыки** | `instance_id` |

#### Memory Utilisation for CRM API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Мониторинг утечек и стабильности |
| **Ярлыки** | `instance_id` |

### 3.4 MES API (RED) - ПРИОРИТЕТНЫЙ

#### Number of requests (RPS) for MES API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | **Критически важно!** MES API используется и операторами, и B2B клиентами для расчета стоимости. Нужно разделять внутренний и внешний трафик |
| **Ярлыки** | `endpoint`, `method`, `client_type` (internal/external/api_partner), `partner_id` |

#### Number of requests (RPS) per user for MES API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Выявление злоупотреблений со стороны API партнеров, основа для rate limiting |
| **Ярлыки** | `user_id`, `partner_id`, `endpoint` |

#### Response time (latency) for MES API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | **Ключевая проблема!** Операторы жалуются на тормоза. Нужно измерять и улучшать |
| **Ярлыки** | `endpoint`, `method`, `quantile`, `operation_type` (list_orders, calculate_price, update_status) |
| **Пороговое значение** | Список заказов: p95 > 1s - critical; Расчет цены: отдельные пороги (это долгая операция) |

#### Number of HTTP 500 for MES API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Ошибки MES = проблемы с производством, потеря заказов |
| **Ярлыки** | `endpoint`, `error_type` |

#### CPU % for MES API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Расчет стоимости 3D модели - CPU-intensive операция. Важно для capacity planning |
| **Ярлыки** | `instance_id` |
| **Пороговое значение** | > 60% sustained - начинать планировать масштабирование |

#### Memory Utilisation for MES API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Обработка 3D моделей может потреблять много памяти |
| **Ярлыки** | `instance_id` |

#### Number of simultaneous sessions for MES API
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Понимание concurrent load, особенно важно для операторов |
| **Ярлыки** | `session_type` (operator/api_client) |

### 3.5 Базы данных (USE)

#### Memory Utilisation for Shop DB instance
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | PostgreSQL использует память для буферов. Недостаток = деградация производительности |
| **Ярлыки** | `db_instance_id`, `db_name` |
| **Пороговое значение** | > 85% - warning |

#### Memory Utilisation for MES DB instance
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Аналогично Shop DB, критично для производительности MES |
| **Ярлыки** | `db_instance_id` |

#### Number of connections for Shop DB instance
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Saturation! Исчерпание connection pool = отказ сервиса |
| **Ярлыки** | `db_instance_id`, `state` (active/idle/waiting) |
| **Пороговое значение** | > 80% от max_connections - warning |

#### Number of connections for MES DB instance
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Аналогично Shop DB |
| **Ярлыки** | `db_instance_id`, `state` |

#### Size of Shop DB instance
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Планирование storage, предотвращение переполнения |
| **Ярлыки** | `db_instance_id` |
| **Пороговое значение** | > 70% capacity - plan expansion |

#### Size of MES DB instance
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | Аналогично Shop DB |
| **Ярлыки** | `db_instance_id` |

### 3.6 S3 Storage (USE)

#### Size of S3 storage
| Параметр | Значение |
|----------|----------|
| **Зачем нужна** | 3D файлы могут занимать много места. Нужно планировать бюджет и retention |
| **Ярлыки** | `bucket_name` |

### 3.7 Дополнительные метрики (не из списка)

#### Order lifecycle metrics (бизнес-метрики)
| Метрика | Описание | Ярлыки |
|---------|----------|--------|
| `order_status_transitions_total` | Счетчик переходов между статусами | `from_status`, `to_status` |
| `order_processing_duration_seconds` | Время нахождения заказа в статусе | `status`, `quantile` |
| `orders_stuck_count` | Количество "зависших" заказов (> N дней в одном статусе) | `status`, `age_bucket` |

**Зачем:** Эти метрики напрямую отвечают на вопрос "где теряются заказы" и позволяют обнаружить проблемы на уровне бизнес-процесса.

#### Price calculation metrics
| Метрика | Описание | Ярлыки |
|---------|----------|--------|
| `price_calculation_duration_seconds` | Время расчета стоимости | `model_complexity` (по количеству полигонов), `quantile` |
| `price_calculation_queue_length` | Очередь на расчет | - |

**Зачем:** Расчет стоимости - узкое место (2-30 минут). Нужно отслеживать для capacity planning.

---

## 4. План действий

### Этап 1: Инфраструктура мониторинга

| # | Задача | Технология | Описание |
|---|--------|------------|----------|
| 1.1 | Развернуть Prometheus | Yandex Managed Prometheus или EC2 | Time-series база для метрик |
| 1.2 | Развернуть Grafana | EC2 / Managed | Визуализация и дашборды |
| 1.3 | Настроить Alertmanager | EC2 | Маршрутизация алертов |
| 1.4 | Интеграция с каналами оповещения | Telegram/Slack/Email | Доставка алертов команде |

### Этап 2: Инструментирование сервисов

| # | Задача | Описание |
|---|--------|----------|
| 2.1 | Добавить Prometheus client в Shop API | Micrometer для Spring Boot, эндпоинт /metrics |
| 2.2 | Добавить Prometheus client в CRM API | Micrometer для Spring Boot |
| 2.3 | Добавить Prometheus client в MES API | prometheus-net для C# |
| 2.4 | Настроить scrape в Prometheus | Конфигурация targets для всех сервисов |

### Этап 3: Мониторинг инфраструктуры

| # | Задача | Описание |
|---|--------|----------|
| 3.1 | PostgreSQL exporter | Метрики БД (connections, replication lag, query time) |
| 3.2 | RabbitMQ exporter | Метрики очередей (messages, consumers, DLQ) |
| 3.3 | Node exporter | Метрики EC2 (CPU, memory, disk, network) |
| 3.4 | Cloudwatch integration | Метрики Yandex Cloud managed services |

### Этап 4: Дашборды и алерты

| # | Задача | Описание |
|---|--------|----------|
| 4.1 | Overview dashboard | Общее здоровье системы |
| 4.2 | API dashboards | По одному на каждый API (Shop, CRM, MES) |
| 4.3 | Database dashboard | Метрики PostgreSQL |
| 4.4 | RabbitMQ dashboard | Очереди и DLQ |
| 4.5 | Business metrics dashboard | Lifecycle заказов |
| 4.6 | Настройка alert rules | Правила для всех критических метрик |

### Этап 5: Процессы

| # | Задача | Описание |
|---|--------|----------|
| 5.1 | Runbook для алертов | Документация: что делать при срабатывании |
| 5.2 | On-call ротация | График дежурств для реагирования |
| 5.3 | Обучение команды | Работа с дашбордами и алертами |

---

## 5. Показатели насыщенности и реагирование (дополнительное задание)

### Пороговые значения насыщенности

| Компонент | Метрика | Warning | Critical | Обоснование |
|-----------|---------|---------|----------|-------------|
| **API CPU** | CPU % | 70% (5 мин) | 90% (2 мин) | 70% - время планировать масштабирование; 90% - деградация неизбежна |
| **API Memory** | Memory % | 80% | 95% | Риск OOM killer |
| **DB Connections** | connections / max | 70% | 90% | Connection exhaustion = отказ |
| **DB Memory** | Memory % | 85% | 95% | Деградация запросов |
| **RabbitMQ Queue** | messages in flight | 2x baseline (15 мин) | 5x baseline | Consumers не справляются |
| **RabbitMQ DLQ** | DLQ count | > 0 | > 10 | Каждое сообщение - потенциальный потерянный заказ |
| **API Error Rate** | 5xx / total | 1% | 5% | Пользовательский опыт |
| **API Latency** | p95 | 1s | 3s | SLA для партнеров |

### Действия при превышении порогов

#### CPU Warning (> 70%)
| Действие | Ответственный | SLA |
|----------|---------------|-----|
| Завести тикет на capacity planning | Дежурный | 24 часа |
| Проверить наличие аномальной нагрузки | Дежурный | 1 час |
| Запланировать добавление инстанса | Тимлид + DevOps | 1 неделя |

#### CPU Critical (> 90%)
| Действие | Ответственный | SLA |
|----------|---------------|-----|
| Автоматическое уведомление в Telegram | Система | немедленно |
| Звонок дежурному если нет реакции 5 мин | PagerDuty/аналог | 5 минут |
| Анализ причины (DDoS, bug, легитимная нагрузка) | Дежурный | 15 минут |
| Эскалация до тимлида если не решено | Дежурный | 30 минут |
| Экстренное масштабирование | DevOps | 1 час |

#### DLQ > 0
| Действие | Ответственный | SLA |
|----------|---------------|-----|
| Уведомление в канал #alerts | Система | немедленно |
| Разбор причины сообщения в DLQ | Дежурный разработчик | 2 часа |
| Retry или ручная обработка | Дежурный разработчик | 4 часа |
| Post-mortem если повторяется | Команда | 1 день |

#### DLQ Critical (> 10)
| Действие | Ответственный | SLA |
|----------|---------------|-----|
| Звонок дежурному | PagerDuty | немедленно |
| Остановка intake новых заказов (если нужно) | Тимлид | 15 минут |
| Массовый разбор DLQ | Команда | 2 часа |
| Уведомление бизнеса | Продакт | 1 час |

#### Error Rate Critical (> 5%)
| Действие | Ответственный | SLA |
|----------|---------------|-----|
| Автоматический rollback если включен | CI/CD | немедленно |
| Уведомление + звонок | Система | немедленно |
| Анализ логов на причину | Дежурный | 15 минут |
| Hotfix или откат версии | Разработчик + DevOps | 1 час |

### Автоматические действия (рекомендуется настроить)

| Триггер | Автоматическое действие | Условие |
|---------|------------------------|---------|
| CPU > 90% (5 мин) | Auto-scaling: добавить инстанс | Если настроен auto-scaling |
| Memory > 95% | Restart pod/container | Kubernetes/ECS |
| Health check failed | Вывести из балансировщика | Load balancer |
| DLQ > 100 | Создать incident в Jira | Интеграция с issue tracker |

---

## 6. Архитектура мониторинга

```
┌─────────────────────────────────────────────────────────────────┐
│                         Сервисы                                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                        │
│  │ Shop API│  │ CRM API │  │ MES API │  + PostgreSQL, RabbitMQ │
│  │ /metrics│  │ /metrics│  │ /metrics│                        │
│  └────┬────┘  └────┬────┘  └────┬────┘                        │
└───────┼────────────┼────────────┼───────────────────────────────┘
        │            │            │
        └────────────┼────────────┘
                     │ scrape
                     ▼
              ┌─────────────┐
              │ Prometheus  │
              │ (metrics DB)│
              └──────┬──────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
 ┌────────────┐ ┌─────────┐ ┌─────────────┐
 │Alertmanager│ │ Grafana │ │ Long-term   │
 │            │ │(dashboards│ │ storage     │
 └──────┬─────┘ └─────────┘ │ (Thanos/    │
        │                    │ VictoriaM.) │
        ▼                    └─────────────┘
 ┌─────────────┐
 │ Notification│
 │ channels    │
 │ - Telegram  │
 │ - Slack     │
 │ - PagerDuty │
 │ - Email     │
 └─────────────┘
```

---

## 7. Выбор технологий

| Компонент | Технология | Альтернативы | Обоснование выбора |
|-----------|------------|--------------|-------------------|
| Metrics DB | **Prometheus** | VictoriaMetrics, InfluxDB | Стандарт индустрии, богатая экосистема, бесплатный |
| Visualization | **Grafana** | Kibana, DataDog | Бесплатный, интеграция с Prometheus из коробки |
| Alerting | **Alertmanager** | PagerDuty native, Opsgenie | Часть Prometheus stack, гибкая маршрутизация |
| Long-term storage | **Thanos** / **VictoriaMetrics** | Cortex | Для хранения метрик > 15 дней |
