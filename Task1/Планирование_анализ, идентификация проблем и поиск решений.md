# Планирование: анализ, идентификация проблем и поиск решений

## 1. Анализ текущей ситуации

### Контекст бизнеса
Компания "Александрит" - ювелирное производство с уникальным предложением: клиенты могут создавать собственный дизайн украшений через 3D-конструктор или загружать готовые модели. Компания активно растет (+100 заказов/месяц) и недавно открыла B2B API для партнеров.

### Текущая архитектура
- **Онлайн-магазин**: Vue + Java Spring Boot
- **CRM**: Vue + Spring Boot (работа с клиентами)
- **MES**: React + C# (производство, расчет стоимости)
- **Инфраструктура**: EC2 инстансы в Yandex Cloud, PostgreSQL (Managed), RabbitMQ, S3
- **Масштабирование**: 1 инстанс на каждое приложение, 1 инстанс БД (read+write)

---

## 2. Идентификация проблем

### 2.1 Критические проблемы (влияют на бизнес прямо сейчас)

| # | Проблема | Симптомы | Причина |
|---|----------|----------|---------|
| 1 | **Потеря заказов** | Клиенты не получают заказы, жалобы от B2C и B2B | Сообщения теряются в RabbitMQ, нет retry/DLQ, нет трейсинга для диагностики |
| 2 | **Зависание заказов** | Заказы месяцами в непонятном статусе вместо 3 недель | Нет мониторинга lifecycle заказа, невозможно понять где "застряло" |
| 3 | **Медленная загрузка MES** | Операторы жалуются на тормоза дашборда | Нет кеширования списка заказов, каждый запрос в БД, один инстанс БД |
| 4 | **Перегрузка после открытия API** | Резкий рост жалоб после B2B интеграции | Нет rate limiting, нет масштабирования, один инстанс обрабатывает всё |

### 2.2 Системные проблемы (архитектурные ограничения)

| # | Проблема | Риск |
|---|----------|------|
| 5 | **Отсутствие observability** | Невозможно диагностировать проблемы, "слепое" управление системой |
| 6 | **Single point of failure** | Один инстанс каждого сервиса - падение = полный отказ |
| 7 | **Нет разделения read/write** | БД - узкое место при росте нагрузки |
| 8 | **Нет механизмов отказоустойчивости** | Потеря сообщений в очередях, нет DLQ, нет retry |
| 9 | **Долгий расчет стоимости** | 2-30 минут синхронно блокирует ресурсы |
| 10 | **Общая БД для Shop и CRM** | Конкуренция за ресурсы между сервисами |

### 2.3 Процессные проблемы

| # | Проблема | Влияние |
|---|----------|---------|
| 11 | **Ручное E2E тестирование** | Задержки релизов до месяца |
| 12 | **Ручной деплой на prod/release** | Медленный цикл доставки изменений |

---

## 3. Инициативы для устранения проблем

### Приоритет 1: КРИТИЧЕСКИЕ (решают текущие бизнес-проблемы)

| # | Инициатива | Решает проблемы | Описание |
|---|------------|-----------------|----------|
| I1 | **Внедрение мониторинга** | 1, 2, 5 | Метрики RED/USE для всех компонентов, дашборды, алертинг |
| I2 | **Внедрение трейсинга** | 1, 2, 5 | Distributed tracing с Jaeger/Zipkin, отслеживание lifecycle заказа |
| I3 | **Внедрение логирования** | 1, 2, 5 | Централизованный сбор логов (ELK/OpenSearch), структурированные логи |
| I4 | **Кеширование в MES** | 3 | Redis cache для списка заказов, Cache-Aside pattern |
| I5 | **DLQ и retry для RabbitMQ** | 1, 8 | Dead Letter Queue, exponential backoff, мониторинг DLQ |

### Приоритет 2: ВАЖНЫЕ (предотвращают будущие проблемы)

| # | Инициатива | Решает проблемы | Описание |
|---|------------|-----------------|----------|
| I6 | **Rate limiting для API** | 4 | Ограничение RPS для B2B клиентов, защита от перегрузки |
| I7 | **Горизонтальное масштабирование** | 4, 6 | Минимум 2 инстанса каждого сервиса, load balancer |
| I8 | **Read replicas для БД** | 3, 7, 10 | Отдельные инстансы для чтения, разгрузка master |
| I9 | **Асинхронный расчет стоимости** | 9 | Webhook callback вместо ожидания, уведомление по готовности |

### Приоритет 3: УЛУЧШЕНИЯ (оптимизация процессов)

| # | Инициатива | Решает проблемы | Описание |
|---|------------|-----------------|----------|
| I10 | **Автоматизация E2E тестов** | 11 | Selenium/Playwright, параллельный запуск |
| I11 | **CI/CD для prod** | 12 | Автоматический деплой после прохождения тестов |
| I12 | **Разделение Shop DB и CRM DB** | 10 | Выделение отдельной БД для CRM |

---

## 4. Приоритизация и план на 6 месяцев

### Ход рассуждений

**Почему observability первый приоритет?**
- Без мониторинга, трейсинга и логирования невозможно понять где именно теряются/зависают заказы
- Это как лечить пациента с завязанными глазами - нужна диагностика
- После внедрения observability станут видны реальные bottleneck-и

**Почему кеширование важнее масштабирования?**
- Проблема MES - конкретная и понятная (тормозит дашборд)
- Кеширование даст быстрый эффект с минимальными изменениями
- Масштабирование требует больше инфраструктурных изменений

**Почему DLQ критичен?**
- Потеря сообщений = потеря заказов = потеря денег и репутации
- Относительно простое изменение с большим эффектом

### Топ-3 инициативы на ближайшие 6 месяцев

#### 1. Observability Stack (I1 + I2 + I3)
**Почему:** Фундамент для всех остальных улучшений. Без visibility невозможно:
- Понять где теряются заказы
- Измерить эффект от изменений
- Проактивно обнаруживать проблемы

**Состав:**
- Prometheus + Grafana для метрик
- Jaeger для distributed tracing
- OpenSearch/ELK для логов
- Alertmanager для уведомлений

**Результат:** Полная видимость системы, возможность диагностики за минуты вместо дней.

#### 2. Кеширование MES (I4)
**Почему:** Прямое решение жалоб операторов, влияет на скорость обработки заказов.

**Состав:**
- Redis cluster
- Cache-Aside pattern для списка заказов
- TTL + инвалидация при изменении статуса

**Результат:** Загрузка дашборда < 1 сек, довольные операторы, быстрее берут заказы.

#### 3. Отказоустойчивость RabbitMQ (I5)
**Почему:** Напрямую решает проблему потери заказов.

**Состав:**
- Настройка Dead Letter Queue для всех очередей
- Retry policy с exponential backoff
- Мониторинг и алерты на DLQ
- Процесс разбора "мертвых" сообщений

**Результат:** Ни одно сообщение не теряется, проблемные кейсы видны и разбираются.

---

## 5. Целевая архитектура через 6 месяцев

### Изменения относительно текущей архитектуры:

```
БЫЛО:                              СТАНЕТ:
─────                              ───────
1 инстанс каждого сервиса    →    2+ инстанса за Load Balancer
1 БД (read+write)            →    Master + Read Replica
Нет мониторинга              →    Prometheus + Grafana + Alertmanager
Нет трейсинга                →    Jaeger + OpenTelemetry
Нет централизованных логов   →    OpenSearch + Logstash/Fluent
Нет кеширования              →    Redis Cluster
RabbitMQ без DLQ             →    RabbitMQ + DLQ + retry policies
Нет rate limiting            →    API Gateway с rate limiting
```

### Компоненты целевой архитектуры:

1. **Observability Layer:**
   - Prometheus (сбор метрик)
   - Grafana (визуализация)
   - Alertmanager (алертинг)
   - Jaeger (трейсинг)
   - OpenSearch (логи)
   - OpenTelemetry Collector (унификация)

2. **Caching Layer:**
   - Redis Cluster (кеширование MES)

3. **Messaging Layer:**
   - RabbitMQ с DLQ
   - Retry policies
   - Monitoring интеграция

4. **API Layer:**
   - API Gateway (rate limiting, authentication)
   - Load Balancer

5. **Data Layer:**
   - PostgreSQL Master (write)
   - PostgreSQL Replica (read)

### Диаграмма (схематично):

```
[Customer/API User]
        │
        ▼
[API Gateway + Rate Limit]
        │
        ▼
[Load Balancer]
   ┌────┼────┐
   ▼    ▼    ▼
[Shop] [CRM] [MES] ──► [Redis Cache]
   │    │    │
   └────┼────┘
        │
        ▼
[RabbitMQ + DLQ]
        │
        ▼
[PostgreSQL Master] ◄──► [Read Replica]

[Все компоненты] ──► [OpenTelemetry Collector]
                            │
              ┌─────────────┼─────────────┐
              ▼             ▼             ▼
         [Prometheus]   [Jaeger]    [OpenSearch]
              │             │             │
              └─────────────┼─────────────┘
                            ▼
                       [Grafana]
                            │
                            ▼
                    [Alertmanager]
```

---

## 6. Необходимые ресурсы

### Команда
Текущего состава (8 человек) достаточно для реализации плана. Возможные дополнения:
- **SRE/DevOps инженер** - помощь с observability и инфраструктурой
- **Backend разработчик** - ускорение реализации

### Инфраструктура
- Redis Managed Service (Yandex Cloud)
- Дополнительные EC2 для observability stack
- PostgreSQL Read Replica
- Увеличение ресурсов для существующих сервисов

---

## 7. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Сложность интеграции tracing в legacy код | Высокая | Средняя | Начать с MES (купленный с исходниками), использовать auto-instrumentation |
| Overhead от observability | Средняя | Низкая | Sampling для трейсинга, оптимизация retention |
| Сопротивление команды изменениям | Средняя | Средняя | Показать value на примере, обучение |
| Недостаток экспертизы в observability | Средняя | Высокая | Обучение, консультации, документация |

---

## 8. Метрики успеха

| Метрика | Текущее | Целевое |
|---------|---------|---------|
| Время диагностики проблемы | Дни | Минуты |
| % потерянных заказов | Неизвестно (нет метрик) | < 0.1% |
| Время загрузки дашборда MES | > 10 сек | < 1 сек |
| Время до обнаружения проблемы | Часы/дни (по жалобам) | Минуты (алерты) |
| Задержка релизов из-за багов | До месяца | < 1 недели |
