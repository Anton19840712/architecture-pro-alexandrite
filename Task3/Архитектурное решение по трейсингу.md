# Архитектурное решение по трейсингу

---

## 1. Мотивация

### Текущие проблемы

Команда "Александрит" сталкивается с критическими проблемами:
- Заказы находятся в непонятном состоянии или зависают на неопределенном этапе
- Сообщения теряются между сервисами (Shop API → RabbitMQ → CRM/MES)
- Невозможно определить, где именно "застрял" конкретный заказ
- Разбор инцидентов занимает дни вместо минут

### Почему нужен трейсинг

**Distributed tracing** позволяет отслеживать путь запроса/заказа через все компоненты распределенной системы. В отличие от логов (точечные события) и метрик (агрегированные данные), трейсинг показывает:
- Полный путь запроса через все сервисы
- Время выполнения каждого этапа
- Точку, где произошла ошибка или задержка
- Причинно-следственные связи между вызовами

### Бизнес-метрики, на которые повлияет трейсинг

| # | Метрика | Текущее состояние | Ожидаемое улучшение |
|---|---------|-------------------|---------------------|
| 1 | **MTTR (Mean Time To Recovery)** | Часы/дни (разбор по жалобам клиентов) | Минуты (прямой переход к проблемному месту) |
| 2 | **Время обработки обращений клиентов** | Долгий разбор без данных | Мгновенный поиск заказа по trace_id |
| 3 | **% потерянных заказов** | Неизвестно | Измеримо, стремится к 0 |

### Технические метрики

| # | Метрика | Описание |
|---|---------|----------|
| 4 | **Latency breakdown по сервисам** | Видно, какой сервис вносит наибольшую задержку |
| 5 | **Error rate по этапам обработки** | Статистика ошибок на каждом этапе lifecycle заказа |

---

## 2. Анализ системы: где заказ может "сломаться" или зависнуть

### Схема с выделением критических точек

```
[Customer] ──► [Internet Shop] ──► [Shop API] ──► [Shop DB]
                                        │
                                        ▼ (1) HTTP call
                                   [RabbitMQ]
                                        │
                          ┌─────────────┼─────────────┐
                          ▼             │             ▼
                    (2) Consume    (3) Consume   (4) Consume
                     [CRM API]         │          [MES API]
                          │            │              │
                          ▼            │              ▼
                    [Shop DB]          │         [MES DB]
                                       │              │
                                       │              ▼
                                       │         [S3 Storage]
                                       │
[API User] ─────────────────────────────────────► [MES API] (5)
```

### Критические точки (потенциальные места потери/зависания)

| # | Точка | Риск | Описание |
|---|-------|------|----------|
| **1** | Shop API → RabbitMQ | Потеря сообщения | Publish без confirm, network timeout |
| **2** | RabbitMQ → CRM API | Зависание/потеря | Consumer упал, сообщение не ack'нуто, reject без DLQ |
| **3** | RabbitMQ → MES API | Зависание/потеря | Аналогично CRM |
| **4** | MES API → RabbitMQ | Потеря статуса | Обновление статуса не доставлено в CRM |
| **5** | API User → MES API | Timeout | Долгий расчет стоимости (до 30 мин) |
| **6** | MES API → MES DB | Зависание | Медленные запросы, deadlock |
| **7** | MES API → S3 | Ошибка | Файл не загрузился/не читается |
| **8** | Shop API → Shop DB | Ошибка записи | Заказ не сохранен |

### Системы для покрытия трейсингом (приоритет)

| Приоритет | Система | Обоснование |
|-----------|---------|-------------|
| **1 (критичный)** | MES API | Ключевой сервис, принимает B2B запросы, взаимодействует со всеми компонентами |
| **2 (критичный)** | Shop API | Entry point для B2C, создание заказов |
| **3 (критичный)** | RabbitMQ | Точка интеграции, место потери сообщений |
| **4 (важный)** | CRM API | Подтверждение заказов, связь с клиентами |
| **5 (желательный)** | Базы данных | Медленные запросы (как spans в трейсах) |
| **6 (желательный)** | S3 | Операции с файлами |

---

## 3. Данные для трейсинга

### Обязательные атрибуты (для всех spans)

| Атрибут | Описание | Пример |
|---------|----------|--------|
| `trace_id` | Уникальный ID всей цепочки | `abc123def456` |
| `span_id` | ID текущего span | `span789` |
| `parent_span_id` | ID родительского span | `span456` |
| `service.name` | Имя сервиса | `shop-api`, `mes-api` |
| `operation.name` | Название операции | `create_order`, `calculate_price` |
| `timestamp` | Время начала | ISO 8601 |
| `duration` | Длительность в мс | `150` |
| `status` | OK / ERROR | `ERROR` |

### Бизнес-атрибуты (специфичные для "Александрит")

| Атрибут | Описание | Где добавлять |
|---------|----------|---------------|
| `order_id` | ID заказа | Все операции с заказом |
| `order_status` | Текущий статус | При изменении статуса |
| `customer_id` | ID клиента | Все операции |
| `partner_id` | ID B2B партнера | API вызовы от партнеров |
| `model_complexity` | Сложность 3D модели | Расчет стоимости |
| `file_id` | ID файла в S3 | Операции с файлами |

### Данные для RabbitMQ

| Атрибут | Описание |
|---------|----------|
| `messaging.system` | `rabbitmq` |
| `messaging.destination` | Имя очереди/exchange |
| `messaging.message_id` | ID сообщения |
| `messaging.operation` | `publish` / `receive` |

---

## 4. Предлагаемое решение

### Архитектура трейсинга

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            СЕРВИСЫ                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │
│  │   Shop API   │  │   CRM API    │  │   MES API    │                   │
│  │ + OTel SDK   │  │ + OTel SDK   │  │ + OTel SDK   │                   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                   │
│         │                 │                 │                            │
│         │    OTLP/gRPC    │                 │                            │
│         └─────────────────┼─────────────────┘                            │
│                           ▼                                              │
│              ┌────────────────────────┐                                  │
│              │  OpenTelemetry         │                                  │
│              │  Collector             │                                  │
│              │  - Receives traces     │                                  │
│              │  - Processes/samples   │                                  │
│              │  - Exports to Jaeger   │                                  │
│              └───────────┬────────────┘                                  │
│                          │                                               │
│                          ▼                                               │
│              ┌────────────────────────┐                                  │
│              │       Jaeger           │                                  │
│              │  - Storage             │                                  │
│              │  - Query               │                                  │
│              │  - UI                  │                                  │
│              └────────────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

### Выбор технологий

| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| **SDK** | OpenTelemetry | Vendor-neutral стандарт, поддержка Java/C#, auto-instrumentation |
| **Collector** | OpenTelemetry Collector | Унификация, буферизация, sampling |
| **Backend** | Jaeger | Open-source, хорошая интеграция с OTel, UI из коробки |
| **Storage** | Elasticsearch (для Jaeger) | Масштабируемость, поиск по атрибутам |

### Реализация по сервисам

#### Shop API (Java Spring Boot)
```
Зависимости:
- opentelemetry-javaagent (auto-instrumentation)
- opentelemetry-api (manual spans)

Конфигурация:
- OTEL_SERVICE_NAME=shop-api
- OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
- OTEL_TRACES_SAMPLER=parentbased_traceidratio
- OTEL_TRACES_SAMPLER_ARG=0.1 (10% sampling в prod)
```

#### CRM API (Java Spring Boot)
```
Аналогично Shop API
```

#### MES API (C# .NET)
```
Зависимости:
- OpenTelemetry.Extensions.Hosting
- OpenTelemetry.Instrumentation.AspNetCore
- OpenTelemetry.Instrumentation.Http
- OpenTelemetry.Exporter.OpenTelemetryProtocol

Конфигурация в Program.cs:
builder.Services.AddOpenTelemetry()
    .WithTracing(tracing => tracing
        .AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .AddOtlpExporter());
```

#### RabbitMQ
```
Propagation:
- Передача trace context через message headers
- W3C Trace Context format (traceparent, tracestate)
```

### План внедрения

| Этап | Задачи | Срок |
|------|--------|------|
| **1. Инфраструктура** | Развернуть Jaeger + OTel Collector | Неделя 1 |
| **2. MES API** | Добавить OTel SDK, настроить auto-instrumentation | Неделя 2 |
| **3. Shop API** | Добавить OTel SDK | Неделя 3 |
| **4. CRM API** | Добавить OTel SDK | Неделя 3 |
| **5. RabbitMQ propagation** | Настроить передачу context через headers | Неделя 4 |
| **6. Custom spans** | Добавить бизнес-атрибуты (order_id, etc.) | Неделя 5 |
| **7. Обучение** | Документация, обучение команды | Неделя 6 |

### Обновленная C4 диаграмма

Ссылка на диаграмму: `Task3/jewerly_c4_model_with_tracing.drawio`

Новые компоненты (выделены красным):
- OpenTelemetry Collector
- Jaeger
- Elasticsearch (для хранения трейсов)

---

## 5. Компромиссы

### Когда трейсинг не принесет пользы

| Ситуация | Объяснение | Альтернатива |
|----------|------------|--------------|
| **Проблемы внутри БД** | Трейсинг покажет только время SQL-запроса, но не explain план | Slow query log, pg_stat_statements |
| **Внешние системы без OTel** | Транспортная компания, внешний API | Логирование на границе, synthetic monitoring |
| **Проблемы сети** | Packet loss между сервисами | Network monitoring, ping/latency probes |
| **Очень редкие ошибки** | При sampling 10% можем пропустить | Увеличить sampling для errors (100%) |

### Когда трейсинг сложно/дорого реализовать

| Ситуация | Сложность | Решение |
|----------|-----------|---------|
| **Legacy код без возможности изменения** | Высокая | Sidecar proxy с auto-instrumentation (Envoy + OTel) |
| **Проприетарные системы** | Высокая | Трейсинг на границе (до и после вызова) |
| **Очень высокий RPS** | Overhead | Агрессивный sampling, tail-based sampling |

### Overhead трейсинга

| Аспект | Влияние | Митигация |
|--------|---------|-----------|
| **CPU** | ~1-3% | Sampling, async export |
| **Network** | Дополнительный трафик к collector | Батчинг, сжатие |
| **Storage** | Зависит от retention | TTL 7-14 дней, sampling |
| **Latency** | < 1ms на span | Async instrumentation |

---

## 6. Безопасность

### Меры защиты

| Мера | Описание | Реализация |
|------|----------|------------|
| **Аутентификация в Jaeger UI** | Доступ только для сотрудников | OAuth2/OIDC через корпоративный IdP |
| **RBAC** | Разные роли для разных команд | Admin: полный доступ; Support: только просмотр; Dev: свой сервис |
| **Network isolation** | Collector и Jaeger во внутренней сети | VPC, Security Groups |
| **TLS** | Шифрование трафика | OTLP over gRPC с TLS |
| **Data masking** | Чувствительные данные не в трейсах | Не логировать PII, пароли, токены |
| **Audit log** | Кто смотрел какие трейсы | Jaeger audit plugin или proxy |

### Чувствительные данные (НЕ включать в трейсы)

- Пароли и токены
- Полные номера карт
- Персональные данные (email, телефон, адрес) - только хеши или ID
- API ключи партнеров

### Доступ к системе трейсинга

| Роль | Доступ |
|------|--------|
| **Разработчики** | Свои сервисы, полные данные |
| **Поддержка** | Все сервисы, поиск по order_id |
| **Операторы MES** | Нет доступа (используют UI MES) |
| **Администраторы** | Полный доступ, управление |

---

## 7. Автоматический мониторинг и алертинг (дополнительное задание)

### Мониторинг на основе данных трейсинга

Jaeger предоставляет метрики, которые можно экспортировать в Prometheus:

| Метрика | Описание | Алерт |
|---------|----------|-------|
| `trace_duration_seconds` | Длительность трейса | p99 > 30s для заказа |
| `span_error_rate` | % ошибок по сервису | > 5% |
| `span_duration_seconds` | Длительность span | p99 > 10s для конкретной операции |

### Архитектура с алертингом (зеленые элементы)

```
[Services] ──► [OTel Collector] ──► [Jaeger]
                     │
                     ├──► [Prometheus] (metrics from spans)
                     │         │
                     │         ▼
                     │    [Alertmanager]
                     │         │
                     │         ▼
                     │    [Notifications]
                     │
                     └──► [Span Metrics Processor]
                               │
                               ▼
                          [Grafana Dashboard]
                          "Order Lifecycle"
```

### Алерты на основе трейсинга

| Алерт | Условие | Действие |
|-------|---------|----------|
| `OrderStuckInStatus` | Заказ > 24ч в статусе без изменений | Уведомление в канал поддержки |
| `HighLatencyPriceCalculation` | Расчет цены > 45 мин | Уведомление DevOps |
| `TraceWithErrors` | Трейс с error span | Автоматический тикет |
| `MissingSpans` | Ожидаемый span отсутствует (gap в trace) | Расследование потери сообщения |

### Дашборд "Order Lifecycle"

Визуализация на основе трейсов:
- Время прохождения заказа через каждый этап
- Heatmap статусов заказов
- Топ-10 самых долгих заказов
- Количество заказов в каждом статусе

Ссылка на диаграмму с алертингом: `Task3/jewerly_c4_model_with_tracing_alerting.drawio`

---

## 8. Итоговая архитектура

### Компоненты решения

1. **OpenTelemetry SDK** в каждом сервисе (Shop API, CRM API, MES API)
2. **OpenTelemetry Collector** - централизованный сбор и обработка
3. **Jaeger** - хранение и UI для трейсов
4. **Elasticsearch** - backend storage для Jaeger
5. **Prometheus** - метрики из трейсов (RED metrics)
6. **Grafana** - дашборды
7. **Alertmanager** - алертинг

### Ожидаемые результаты

| Метрика | До | После |
|---------|-----|-------|
| Время диагностики проблемы | Часы/дни | Минуты |
| Возможность найти конкретный заказ | Ручной разбор логов | Поиск по order_id за секунды |
| Видимость потерянных сообщений | Нет | Полная |
| Понимание узких мест | Субъективное | Количественное (latency breakdown) |
